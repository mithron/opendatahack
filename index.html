<html>
<head>
	<title>Московские школы</title>
	<meta charset="utf-8">
	
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>	

    <link rel="stylesheet" href="leaflet-dvf/dist/css/dvf.css" type="text/css" />
    <script type="text/javascript" src="leaflet-dvf/dist/leaflet-dvf.min.js"></script>
    <script type="text/javascript" src="leaflet-dvf/src/leaflet.dvf.experimental.js"></script>

    <link rel="stylesheet" href="Leaflet.StyledLayerControl/css/styledLayerControl.css" />
    <script src="Leaflet.StyledLayerControl//src/styledLayerControl.js"></script>
	
	<script src="leaflet-sidebar/src/L.Control.Sidebar.js"></script>
	<link rel="stylesheet" href="leaflet-sidebar/src/L.Control.Sidebar.css" />
	
	<link rel="stylesheet" href="Leaflet.loading/src/Control.Loading.css" />
    <script src="Leaflet.loading/src/Control.Loading.js"></script>
	
	<script src="spin.min.js"></script>
	
</head>
<body>
	<div id="hidden"><audio src="http://tts.voicetech.yandex.net/generate?text='Здравствуйте%20%20%20Перед%20вами%20%20справочник%20по%20расходам%20московских%20школ%20%20%20Здесь%20представлены%20расходы%20лучших%20школ%20Москвы%20%20тех%20школ%20%20которые%20входили%20хотя%20бы%20раз%20в%20список%20что%20выпускается%20ежегожно%20Департаментом%20Образования%20Москвы%20%20%20Пока%20что%20загружаются%20данные%20немного%20об%20этом%20инструменте%20%20В%20правой%20панели%20Вы%20можете%20выбрать%20те%20школы%20которые%20вас%20интересуют%20Они%20будут%20представлены%20на%20карте%20У%20выбранных%20школ%20будет%20отображена%20круговая%20диаграмма%20расходов%20%20%20На%20диаграмме%20пропорционально%20сумме%20отображены%20контакты,%20при%20наведении%20мышки%20на%20них%20во%20всплывающем%20окне%20показана%20сумма%20и%20поставщик%2%20%200Школы%20линиями%20соединены%20с%20поставщиками%20%20%20Толщина%20линии%20пропорциональна%20сумме%20контракта%20Если%20кликнуть%20линию%20то%20будет%20показано%20местоположение%20поставщика%20и%20его%20название%20%20%20Цвет%20индивидуально%20идентифицирует%20поставщика%20%20%20Цвет%20на%20круговой%20диаграмме%20и%20линии%20совпадает'&format=mp3&lang=ru-RU&speaker=zahar&key=519d3768-9302-4f28-8eab-0eb1bf9579d5" autoplay="autoplay" type="audio/mp3" preload="none"></audio></div>
	
	<div id="sidebar">
		<h1>Здравствуйте!</h1>		
		<p>Перед вами - справочник по расходам московских школ. Здесь представлены расходы лучших школ Москвы - тех школ, которые входили хотя бы раз в тот список, что выпускается ежегожно Департаментом Образования Москвы. </p>
		<p>Пока что загружаются данные - немного об этом инструменте. </p>
		<p>В правой панели Вы можете выбрать те школы, которые вас интересуют. Они будут представлены на карте. У выбранных школ будет отображена круговая диаграмма расходов. На диаграмме пропорционально сумме отображены контакты, при наведении мышки на них во всплывающем окне показана сумма и поставщик. </p>
		<p>Школы линиями соединены с поставщиками. Толщина линии пропорциональна сумме контракта. Если кликнуть линию, то будет показано местоположение поставщика и его название. 
		</p>
		<p>Цвет индивидуально идентифицирует поставщика. Цвет на круговой диаграмме и линии совпадает.</p>		
	</div>
	<div id="map"></div>
	
	<script src="schools_data_short.js"></script>
   
	<script>
	var map;

	var resize = function () {
		var $map = $('#map');

		$map.height($(window).height() - $('div.navbar').outerHeight());

		if (map) {
			map.invalidateSize();
		}
	};

	$(window).on('resize', function () {
		resize();
	});

	resize();

	map = L.map('map').setView([55.75, 37.63], 10);
	
	var accessToken = 'pk.eyJ1IjoibWl0aHJvbiIsImEiOiJiT0wwZkMwIn0.MnqefBaviEHMB3li6tpL4g';
	var mapboxTiles = L.tileLayer('https://{s}.tiles.mapbox.com/v4/mithron.lake28fh/{z}/{x}/{y}.png?access_token=' + accessToken, { maxZoom: 18, 
				attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
				}).addTo(map);	

        // Add a layer control
    var base = [];
    var over = [];
    var layerControl = L.Control.styledLayerControl(base, over, { collapsed:false, container_width: "200px",
            container_maxHeight: "550px",  group_maxHeight: "550px", exclusive: false}).addTo(map);
		 
	var loadingControl = L.Control.loading({
            separate: true, spinjs:true, 
			spin: { lines: 15, length: 5, width: 5, radius: 4, corners: 1, rotate: 13,
			direction: 1, color: '#000', speed: 1, trail: 60, shadow: false, hwaccel: false, 
			zIndex: 2e9, top: '50%', left: '50%' 
			}
                });
    map.addControl(loadingControl);
	map.fire("dataloading");
	
	var sidebar = L.control.sidebar('sidebar', {
            closeButton: true,
            position: 'left'
       });
    map.addControl(sidebar);
    setTimeout(function () {
            sidebar.show();
        }, 50);	
	var lineWeight1m = new L.LinearFunction(new L.Point(50000, 1), new L.Point(1000000, 12));
	var lineWeight50m = new L.LinearFunction(new L.Point(1000001, 12), new L.Point(50000000, 25));
	var lineWeight = new L.PiecewiseFunction([lineWeight1m, lineWeight50m]);

	var firmColor = new L.HSLHueFunction(new L.Point(0, 260), new L.Point(1024, 0),
						{outputLuminosity: '40%', oddity:0, preProcess: function(value) {
							if (this.options.oddity == 1){
								this.options.oddity = 0;
								value = 1024 - value;
                                if(value<0) {return 0-value;}
                                else {	return value; }
								}
							else { this.options.oddity = 1; return value ;}							
							}
						});
	
	for(var i=0; i<schoolData.length; i++) {		
		if (schoolData[i].inn){
			var url = 'https://intense-journey-6292.herokuapp.com/'+ schoolData[i].inn +'/';
			$.getJSON(url, function(data) {
			  if (data != 0){
			    map.fire('dataloading');
				var suppliers = data[0].suppliers;
				var group = L.layerGroup();
				var colorCounter = 0;
				var options = { data: { }, chartOptions: {},
                    weight: 1, radius: 36, fillOpacity: 1,
                    rotation: 0.0, position: { x: 0, y: 0 },
				    tooltipOptions: {
							iconSize: new L.Point(120, 100),
							iconAnchor: new L.Point(-5, 64)
							},                    
                    barThickness: 26
                };
				for (var key in data[0].suppliers) {
					if (data[0].suppliers.hasOwnProperty(key)) {						
						var date = data[0].suppliers[key].sign_date.split('-')[0];
						
						options.data["'" + data[0].suppliers[key].name+ "'"] = data[0].suppliers[key].summ;						
						
						var dataColor = firmColor.evaluate(colorCounter);
                        colorCounter = colorCounter + 10;
						var text = data[0].suppliers[key].name + " - Контракт на " + data[0].suppliers[key].summ + " рублей";
						var dataWeight = lineWeight.evaluate(data[0].suppliers[key].summ);
						
						options.chartOptions["'"+ data[0].suppliers[key].name+ "'"] =
                           { color: dataColor,
                            fillColor: dataColor,						
                             minValue: 0, maxValue: 50000000,
							 text: text							 
                            } ;
							
                        var arcedPolyline = new L.ArcedPolyline([[data[0].lat,data[0].lng],
                                    [data[0].suppliers[key].lat,data[0].suppliers[key].lng] ], {
                                //        distanceToHeight: new L.LinearFunction([0, 0], [4000, 400]),
								       fillColor: dataColor, 
									   color: dataColor,
								       weight: dataWeight, displayText: text });
						arcedPolyline.bindPopup(text, {autoPanPadding: L.point(300, 200) });
						arcedPolyline.on("click", function(e) {
							e.target.openPopup();
						});
						arcedPolyline.on("popupclose", function(e) {
								map.setView([55.75, 37.63], 10);
						});
						/*
						arcedPolyline.on("mouseover", function(e) {
								console.log(e.target);
								
						});*/

                        group.addLayer(arcedPolyline);						
						};
					};			
				var marker = new L.PieChartMarker(new L.LatLng(data[0].lat,data[0].lng),
                               options);                            
				marker.on("click", function(e) {					
					console.log(e.target);
					console.log(e.layer);
					sidebar.setContent(e.target.options.chartOptions[e.layer.options.key].text);
					sidebar.show();
					});				
                if (group.getLayers() != 0) {
					group.addLayer(marker);					
                    layerControl.addOverlay(group, data[0].full_name, {groupName : "Школы Москвы", expanded:true});
					//console.log('Done ' + data[0].full_name);
				}                
				 map.fire('dataload');
			}});
		}
	}
	map.fire("dataload");
	</script>
</body></html>
