<html>
<head>
	<title>Московские школы</title>
	<meta charset="utf-8">
	
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>	

    <link rel="stylesheet" href="leaflet-dvf/dist/css/dvf.css" type="text/css" />
    <script type="text/javascript" src="leaflet-dvf/dist/leaflet-dvf.min.js"></script>
 
    <link rel="stylesheet" href="Leaflet.StyledLayerControl/css/styledLayerControl.css" />
    <script src="Leaflet.StyledLayerControl//src/styledLayerControl.js"></script>
	
	<script src="leaflet-sidebar/src/L.Control.Sidebar.js"></script>
	<link rel="stylesheet" href="leaflet-sidebar/src/L.Control.Sidebar.css" />
	
	<link rel="stylesheet" href="Leaflet.loading/src/Control.Loading.css" />
    <script src="Leaflet.loading/src/Control.Loading.js"></script>
	
	<link rel="stylesheet" href="Leaflet.label/dist/leaflet.label.css" />
    <script src="Leaflet.label/dist/leaflet.label.js"></script>
	
	<script src="spin.min.js"></script>
	
</head>
<body>
	<div id="hidden"><audio id="instrPlayer" src="http://tts.voicetech.yandex.net/generate?text='Здравствуйте%20%20%20Перед%20вами%20%20справочник%20по%20расходам%20московских%20школ%20%20%20Здесь%20представлены%20расходы%20лучших%20школ%20Москвы%20%20тех%20школ%20%20которые%20входили%20хотя%20бы%20раз%20в%20список%20что%20выпускается%20ежегожно%20Департаментом%20Образования%20Москвы%20%20%20Пока%20что%20загружаются%20данные%20немного%20об%20этом%20инструменте%20%20В%20правой%20панели%20Вы%20можете%20выбрать%20те%20школы%20которые%20вас%20интересуют%20Они%20будут%20представлены%20на%20карте%20У%20выбранных%20школ%20будет%20отображена%20круговая%20диаграмма%20расходов%20%20%20На%20диаграмме%20пропорционально%20сумме%20отображены%20контакты,%20при%20наведении%20мышки%20на%20них%20во%20всплывающем%20окне%20показана%20сумма%20и%20поставщик%2%20%200Школы%20линиями%20соединены%20с%20поставщиками%20%20%20Толщина%20линии%20пропорциональна%20сумме%20контракта%20Если%20кликнуть%20линию%20то%20будет%20показано%20местоположение%20поставщика%20и%20его%20название%20%20%20Цвет%20индивидуально%20идентифицирует%20поставщика%20%20%20Цвет%20на%20круговой%20диаграмме%20и%20линии%20совпадает'&format=mp3&lang=ru-RU&speaker=zahar&key=519d3768-9302-4f28-8eab-0eb1bf9579d5" autoplay="autoplay" type="audio/mp3" preload="none"></audio></div>
	
	<div id="sidebar">
		<h1>Здравствуйте!</h1>		
		<p>Перед вами - справочник по расходам московских школ. Здесь представлены расходы лучших школ Москвы - тех школ, которые входили хотя бы раз в тот список, что выпускается ежегожно Департаментом Образования Москвы. </p>
		<p>Пока что загружаются данные - немного об этом инструменте. </p>
		<p>В правой панели Вы можете выбрать те школы, которые вас интересуют. Они будут представлены на карте. У выбранных школ будет отображена круговая диаграмма расходов. На диаграмме пропорционально сумме отображены контакты, при наведении мышки на них во всплывающем окне показана сумма и поставщик. </p>
		<p>Школы линиями соединены с поставщиками. Толщина линии пропорциональна сумме контракта. Если кликнуть линию, то будет показано местоположение поставщика и его название. 
		</p>
		<p>Цвет индивидуально идентифицирует поставщика. Цвет на круговой диаграмме и линии совпадает.</p>
		<p>В проекте использованы: данные Департамента Образования города Москвы(списки лучших школ), открытые данные о  школах (дасасет 747) Портала открытых данных Правительства Москвы, а также открытые данные о госзакупках проекта ГосЗатраты. Подробности о проекте см. <a target="_blank" href="https://docs.google.com/document/d/1N6m1Snru_fbvPqIr1hWMTvsbBWLc6mCHfhvOYXg73-E/pub">тут</a>.</p>		
	</div>
	<div id="map"></div>
	
	<script src="schools_data_short.js"></script>
   
	<script>
	var map;

	var resize = function () {
		var $map = $('#map');

		$map.height($(window).height() - $('div.navbar').outerHeight());

		if (map) {
			map.invalidateSize();
		}
	};

	$(window).on('resize', function () {
		resize();
	});

	resize();

	map = L.map('map').setView([55.75, 37.63], 10);
	
	var accessToken = 'pk.eyJ1IjoibWl0aHJvbiIsImEiOiJiT0wwZkMwIn0.MnqefBaviEHMB3li6tpL4g';
	var mapboxTiles = L.tileLayer('https://{s}.tiles.mapbox.com/v4/mithron.lake28fh/{z}/{x}/{y}.png?access_token=' + accessToken, { maxZoom: 18, 
				attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
				}).addTo(map);	

        // Add a layer control
    var base = [];
    var over = [];
    var layerControl = L.Control.styledLayerControl(base, over, { collapsed:false, container_width: "200px",
            container_maxHeight: "550px",  group_maxHeight: "550px", exclusive: false}).addTo(map);
		 
	var loadingControl = L.Control.loading({
            separate: true, spinjs:true, 
			spin: { lines: 15, length: 5, width: 5, radius: 4, corners: 1, rotate: 13,
			direction: 1, color: '#000', speed: 1, trail: 60, shadow: false, hwaccel: false, 
			zIndex: 2e9, top: '50%', left: '50%' 
			}
                });
    map.addControl(loadingControl);
	map.fire("dataloading");
	
	var invisibleIcon = L.icon({
			iconUrl: 'transparent.png',
			shadowUrl: 'transparent.png',
			iconSize:     [1, 1], // size of the icon
			shadowSize:   [1, 1], // size of the shadow
			iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
			shadowAnchor: [0, 0],  // the same for the shadow
			popupAnchor:  [0, 0], // point from which the popup should open relative to the iconAnchor
			labelAnchor:  [1,1]
});
	
	var sidebar = L.control.sidebar('sidebar', {
            closeButton: true,
            position: 'left'
       });
    map.addControl(sidebar);
    setTimeout(function () {
            sidebar.show();
        }, 50);	
	var lineWeight1m = new L.LinearFunction(new L.Point(50000, 1), new L.Point(1000000, 12));
	var lineWeight50m = new L.LinearFunction(new L.Point(1000001, 12), new L.Point(50000000, 25));
	var lineWeight = new L.PiecewiseFunction([lineWeight1m, lineWeight50m]);
	
	var diagOffset = new L.LinearFunction(new L.Point(2011, -110), new L.Point(2014, 110));

	var firmColor = new L.HSLHueFunction(new L.Point(0, 260), new L.Point(1024, 0),
						{outputLuminosity: '40%', oddity:0, preProcess: function(value) {
							if (this.options.oddity == 1){
								this.options.oddity = 0;
								value = 1024 - value;
                                if(value<0) {return 0-value;}
                                else {	return value; }
								}
							else { this.options.oddity = 1; return value ;}							
							}
						});

    function stopAudio(id)  {
        if(document.getElementById('instrPlayer') != null && id != 'instrPlayer' ) {
            document.getElementById('instrPlayer').pause();
            }
        if(document.getElementById('sidebarPlayer') != null && id != 'sidebarPlayer') {
            document.getElementById('sidebarPlayer').pause();
        }
        if(document.getElementById('popupPlayer') != null && id != 'popupPlayer') {
            document.getElementById('popupPlayer').pause();
        }
        document.getElementById(id).play();
    }
	
	for(var i=0; i<schoolData.length; i++) {
    // for(var i=0; i<10; i++) {
		if (schoolData[i].inn){
            var marker = new L.Marker([schoolData[i].lat,schoolData[i].lng], options = { inn: schoolData[i].inn} );
            var group = L.layerGroup([marker]);

            layerControl.addOverlay(group, schoolData[i].full_name, {groupName : "Школы Москвы", expanded:true});
        }}

    map.on("overlayadd", function(e) {
            var group = e.layer;
            var layers = group.getLayers();
			map.fire('dataloading');
            if(layers.length == 1 ) {   
                    var url = 'https://intense-journey-6292.herokuapp.com/'+ layers[0].options.inn +'/';
                    group.clearLayers();
                    $.getJSON(url, function(data) {
                        if (data != 0){                    
                           
                            var suppliers = data[0].suppliers;
                            var colorCounter = 0;
                            var options = { };

                            for (var key in data[0].suppliers) {
                                if (data[0].suppliers.hasOwnProperty(key)) {
                                    var date = data[0].suppliers[key].sign_date.split('-')[0];
                                    var dataColor = firmColor.evaluate(colorCounter);
                                    colorCounter = colorCounter + 10;
                                    var text = "<p>&nbsp;</p><h3><a href='http://schools.mithron.me/?school=" + data[0].inn + "'>" + data[0].full_name + "</a></h3><p>Контракт c " + data[0].suppliers[key].name + " на " + data[0].suppliers[key].summ + " рублей заключен в " + date + " году.</p> <p>Предмет контракта: " +data[0].suppliers[key].product_name + "</p>" + "<p>Адрес поставщика: " +data[0].suppliers[key].address + "</p><p>Расширенные сведения о контракте см. <a target='_blank' href='http://clearspending.ru/contract/"+data[0].suppliers[key].cont_id+"'>тут</a>.</p>" ;
									
									var text2 = "Контракт c " + data[0].suppliers[key].name + " на " + data[0].suppliers[key].summ + " рублей заключен в " + date + " году.";
									
									var audio2 = '<audio id="popupPlayer" src=' +"'" +'http://tts.voicetech.yandex.net/generate?text=%27' + data[0].full_name + " Контракт c " + data[0].suppliers[key].name + " на " + data[0].suppliers[key].summ + " рублей заключен в " + date + " году.%27" + '&format=mp3&lang=ru-RU&speaker=zahar&key=519d3768-9302-4f28-8eab-0eb1bf9579d5'+ "'" + ' autoplay="autoplay" type="audio/mp3" preload="none"></audio></div>';
									
									text2 = audio2+text2;

                                    var dataWeight = lineWeight.evaluate(data[0].suppliers[key].summ);
                                    var dataOffset = diagOffset.evaluate(date);

									var audio = '<audio id="sidebarPlayer" src=' +"'" +'http://tts.voicetech.yandex.net/generate?text=%27' + data[0].full_name + " Контракт c " + data[0].suppliers[key].name + " на " + data[0].suppliers[key].summ + " рублей заключен в " + date + " году. Предмет контракта: " +data[0].suppliers[key].product_name + " Адрес поставщика: " +data[0].suppliers[key].address +"%27" +'&format=mp3&lang=ru-RU&speaker=zahar&key=519d3768-9302-4f28-8eab-0eb1bf9579d5'+ "'" + ' autoplay="autoplay" type="audio/mp3" preload="none"></audio></div>';
									text = audio + text;
									
                                    if(typeof options[date] != "undefined"){
                                        options[date].data["'" + data[0].suppliers[key].name+ "'"] = 							data[0].suppliers[key].summ;
                                        options[date].chartOptions["'"+ data[0].suppliers[key].name+ "'"] =
                                        { color: dataColor,
                                            fillColor: dataColor,
                                            minValue: 0, maxValue: 50000000,
                                            text: text,
                                        } ;
                                    }
                                    else {
                                        options[date] = { data: { }, chartOptions: {},
                                            weight: 1, radius: 36, fillOpacity: 1,
                                            rotation: 0.0, position: { x: dataOffset, y: 0 },
                                            tooltipOptions: {
                                                iconSize: new L.Point(120, 100),
                                                iconAnchor: new L.Point(-5, 64)
                                            },
                                            barThickness: 26
                                        };
                                        // options[date].position.x = dataOffset;
                                        options[date].data["'" + data[0].suppliers[key].name+ "'"] = 							data[0].suppliers[key].summ;
                                        options[date].chartOptions["'"+ data[0].suppliers[key].name+ "'"] =
                                        { color: dataColor,
                                            fillColor: dataColor,
                                            minValue: 0, maxValue: 50000000,
                                            text: text
                                        } ;
                                    }




                                    var arcedPolyline = new L.ArcedPolyline([[data[0].lat,data[0].lng],
                                        [data[0].suppliers[key].lat,data[0].suppliers[key].lng] ], {
                                        //        distanceToHeight: new L.LinearFunction([0, 0], [4000, 400]),
                                        fillColor: dataColor,
                                        color: dataColor,
                                        weight: dataWeight, displayText: text });
                                    arcedPolyline.bindPopup(text2, {autoPanPadding: L.point(300, 200) });

                                    arcedPolyline.on("click", function(e) {
                                        e.target.openPopup();
                                    });

                                    arcedPolyline.on("popupopen", function(e) {
                                        stopAudio('popupPlayer');
                                    });

                                    arcedPolyline.on("popupclose", function(e) {
                                        map.setView([55.75, 37.63], 10);
                                    });
                                    /*
                                     arcedPolyline.on("mouseover", function(e) {
                                     console.log(e.target);

                                     });*/

                                     group.addLayer(arcedPolyline);
                                     };
                                };
                          for(i=2011;i<2015;i++){
                             if(typeof options[i] != "undefined"){
                                var marker = new L.PieChartMarker(new L.LatLng(data[0].lat,data[0].lng),
                                     options[i]);
                                marker.on("click", function(e) {
                                     sidebar.hide();
                                     sidebar.setContent(e.layer.options.chartOptions[e.layer.options.key].text);
                                     stopAudio('sidebarPlayer');
                                     sidebar.show();

                                     });
                                group.addLayer(marker);
								var hiddenMarker = new L.Marker(new L.LatLng(data[0].lat,data[0].lng), {icon: invisibleIcon}).bindLabel(i + " год", {noHide: true, offset: [diagOffset.evaluate(i)-33, 40]});
								group.addLayer(hiddenMarker);
                            }};

                            if (group.getLayers() != 0) {
									 var hiddenMarker = new L.Marker(new L.LatLng(data[0].lat,data[0].lng), {icon: invisibleIcon}).bindLabel(" " + data[0].full_name, {noHide: true, offset: [-200, -70], direction: 'auto'});
									 group.addLayer(hiddenMarker);
                                     layerControl.addOverlay(group, data[0].full_name, {groupName : "Школы Москвы", expanded:true});
                               }
						    map.fire('dataload');
                           }	
					else { map.fire('dataload');}
					});
             }
			 else {
				map.fire('dataload'); }
           
	});

	map.fire("dataload");

    // as of http://stackoverflow.com/questions/11582512/how-to-get-url-parameters-with-javascript/11582513#11582513

    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
    }

    var schoolINN = getURLParameter('school').split('/')[0];
    if (schoolINN != null) {
        for(var key in layerControl._layers) {
            if (layerControl._layers.hasOwnProperty(key)) {
                if(layerControl._layers[key].layer._layers[key-1].options.inn == schoolINN) {
                    layerControl._layers[key].layer.addTo(map);
                }
            }
        }
    }



	</script>
</body></html>
